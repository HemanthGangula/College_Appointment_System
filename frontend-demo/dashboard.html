<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dashboard - College Appointment System</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <h1 id="dashboard-title">Dashboard</h1>
    <nav>
        <a href="index.html">Home</a> |
        <a href="#" id="logout-button">Logout</a>
    </nav>

    <!-- Professor Section -->
    <div id="professor-section" style="display: none;">
        <h2>Professor Dashboard</h2>
        <button id="add-availability">Add Availability</button>
        <div id="availability-form" style="display: none;">
            <label for="date">Date:</label>
            <input type="date" id="date" name="date"><br>
            <label for="time_slots">Time Slots (comma separated):</label>
            <input type="text" id="time_slots" name="time_slots"><br>
            <button id="submit-availability">Submit</button>
        </div>
        <p id="availability-message"></p>
    </div>

    <!-- Student Section -->
    <div id="student-section" style="display: none;">
        <h2>Student Dashboard</h2>
        <button id="logout-button-student">Logout</button>
        <div id="professors-list">
            <!-- Professors and their availability will be listed here -->
        </div>
        <p id="appointment-message"></p>
    </div>

    <script>
        // Handle Logout
        document.getElementById('logout-button')?.addEventListener('click', function(e) {
            e.preventDefault();
            localStorage.removeItem('access_token');
            window.location.href = 'index.html';
        });

        document.getElementById('logout-button-student')?.addEventListener('click', function(e) {
            e.preventDefault();
            localStorage.removeItem('access_token');
            window.location.href = 'index.html';
        });

        // Load Dashboard based on Role
        document.addEventListener('DOMContentLoaded', async () => {
            const token = localStorage.getItem('access_token');
            if (!token) {
                window.location.href = 'login.html';
                return;
            }

            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                const role = payload.role;

                if (role === 'professor') {
                    document.getElementById('dashboard-title').textContent = 'Professor Dashboard';
                    document.getElementById('professor-section').style.display = 'block';
                } else if (role === 'student') {
                    document.getElementById('dashboard-title').textContent = 'Student Dashboard';
                    document.getElementById('student-section').style.display = 'block';
                    loadProfessors();
                }
            } catch (error) {
                console.error('Error decoding token:', error);
                window.location.href = 'login.html';
            }
        });

        const addAvailabilityBtn = document.getElementById('add-availability');
        if (addAvailabilityBtn) {
            addAvailabilityBtn.addEventListener('click', () => {
                document.getElementById('availability-form').style.display = 'block';
            });
        }

        const submitAvailabilityBtn = document.getElementById('submit-availability');
        if (submitAvailabilityBtn) {
            submitAvailabilityBtn.addEventListener('click', async () => {
                const date = document.getElementById('date').value;
                const time_slots = document.getElementById('time_slots').value.split(',');

                try {
                    const response = await fetch('http://localhost:5000/api/availability', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                        },
                        body: JSON.stringify({ date, time_slots })
                    });

                    const result = await response.json();
                    const message = document.getElementById('availability-message');

                    if (response.status === 201) {
                        message.style.color = 'green';
                        message.textContent = 'Availability added successfully.';
                    } else {
                        message.style.color = 'red';
                        message.textContent = result.msg;
                    }
                } catch (error) {
                    const message = document.getElementById('availability-message');
                    message.style.color = 'red';
                    message.textContent = 'Server error. Please try again later.';
                }
            });
        }

        async function loadProfessors() {
            try {
                const token = localStorage.getItem('access_token');
                const response = await fetch('http://localhost:5000/api/availability', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const availability = await response.json();
                    const professorsList = document.getElementById('professors-list');
                    professorsList.innerHTML = ''; // Clear existing content

                    if (availability.length === 0) {
                        professorsList.textContent = 'No professors available at the moment.';
                        return;
                    }

                    availability.forEach(slot => {
                        const profDiv = document.createElement('div');
                        profDiv.innerHTML = `
                            <h3>Professor ID: ${slot.professor_id}</h3>
                            <p>Date: ${slot.date}</p>
                            <p>Available Slots: ${slot.time_slots.join(', ')}</p>
                            <button onclick="requestAppointment('${slot.professor_id}', '${slot.date}', '${slot.time_slots.join(', ')}')">Request Appointment</button>
                        `;
                        professorsList.appendChild(profDiv);
                    });
                } else {
                    const message = document.getElementById('appointment-message');
                    message.style.color = 'red';
                    message.textContent = 'Failed to load professors.';
                }
            } catch (error) {
                console.error('Error fetching availability:', error);
                    message.textContent = 'Appointment requested successfully.';
                const message = document.getElementById('appointment-message');
                message.style.color = 'red';
                message.textContent = 'Failed to load professors.';
            }
        }

        async function requestAppointment(professor_id, date, time_slot) {
            try {
                const response = await fetch('http://localhost:5000/api/appointments', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                    },
                    body: JSON.stringify({ professor_id, date, time_slot })
                });

                const result = await response.json();
                const message = document.getElementById('appointment-message');

                if (response.status === 201) {
                    message.style.color = 'green';
                    message.textContent = 'Appointment requested successfully.';
                } else {
                    message.style.color = 'red';
                    message.textContent = result.msg;
                }
            } catch (error) {
                const message = document.getElementById('appointment-message');
                message.style.color = 'red';
                message.textContent = 'Server error. Please try again later.';
            }
        }
    </script>
</body>
</html>
                } else {
                    message.style.color = 'red';
                    message.textContent = result.msg;
                }
            } catch (error) {
                const message = document.getElementById('appointment-message');
                message.style.color = 'red';
                message.textContent = 'Server error. Please try again later.';
            }
        }
    </script>
</body>
</html>